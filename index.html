<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ADV Handbook Acknowledgement</title>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<style>
  :root {
    --navy: #1B2A4A;
    --navy-light: #2A3F6A;
    --white: #FFFFFF;
    --gray-50: #F8F9FA;
    --gray-100: #F1F3F5;
    --gray-200: #E9ECEF;
    --gray-300: #DEE2E6;
    --gray-400: #ADB5BD;
    --gray-600: #6C757D;
    --gray-800: #343A40;
    --green: #2E7D32;
    --green-light: #E8F5E9;
    --red: #C62828;
    --red-light: #FFEBEE;
    --font-body: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --radius: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-body);
    background: var(--gray-50);
    color: var(--gray-800);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  /* ── Header ── */
  .header {
    background: var(--navy);
    color: var(--white);
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .header-title {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }
  .header-sub {
    font-size: 12px;
    opacity: 0.75;
    margin-top: 2px;
    font-weight: 400;
  }

  /* ── Main Container ── */
  .container {
    max-width: 640px;
    margin: 0 auto;
    padding: 16px;
  }

  /* ── Card ── */
  .card {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 16px;
    overflow: hidden;
  }
  .card-header {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--gray-600);
    padding: 14px 18px 0;
  }
  .card-body { padding: 14px 18px 18px; }

  /* ── Acknowledgement Text ── */
  .ack-text {
    font-size: 13.5px;
    line-height: 1.65;
    color: var(--gray-800);
    max-height: 260px;
    overflow-y: auto;
    padding: 14px 18px;
    -webkit-overflow-scrolling: touch;
  }
  .ack-text p { margin-bottom: 12px; }
  .ack-text p:last-child { margin-bottom: 0; }
  .scroll-hint {
    font-size: 11px;
    color: var(--gray-400);
    text-align: center;
    padding: 6px 0 2px;
  }

  /* ── Consent Checkbox ── */
  .consent-box {
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    padding: 14px 16px;
    margin: 14px 18px 18px;
  }
  .consent-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    font-size: 12.5px;
    line-height: 1.55;
    color: var(--gray-800);
  }
  .consent-label input[type="checkbox"] {
    margin-top: 3px;
    width: 20px;
    height: 20px;
    min-width: 20px;
    accent-color: var(--navy);
    cursor: pointer;
  }

  /* ── Form Fields ── */
  .field-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--gray-600);
    margin-bottom: 8px;
    display: block;
  }
  .text-input {
    width: 100%;
    padding: 14px 16px;
    font-size: 16px; /* prevents iOS zoom */
    font-family: var(--font-body);
    border: 1.5px solid var(--gray-300);
    border-radius: 6px;
    background: var(--white);
    color: var(--gray-800);
    transition: border-color 0.2s;
  }
  .text-input:focus {
    outline: none;
    border-color: var(--navy);
    box-shadow: 0 0 0 3px rgba(27,42,74,0.1);
  }
  .text-input::placeholder { color: var(--gray-400); }
  .text-input[readonly] {
    background: var(--gray-100);
    color: var(--gray-600);
  }

  /* ── Signature Area (Locked Preview) ── */
  .sig-preview {
    position: relative;
    border: 1.5px solid var(--gray-300);
    border-radius: 6px;
    background: var(--white);
    overflow: hidden;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .sig-preview.has-sig {
    cursor: default;
    border-color: var(--green);
    background: var(--green-light);
  }
  .sig-preview img {
    max-width: 100%;
    max-height: 80px;
    display: block;
    padding: 8px;
  }
  .sig-tap-prompt {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    color: var(--gray-400);
    padding: 16px;
  }
  .sig-tap-prompt svg {
    width: 28px;
    height: 28px;
    opacity: 0.5;
  }
  .sig-tap-prompt span {
    font-size: 14px;
    font-weight: 500;
  }
  .sig-locked-actions {
    display: flex;
    justify-content: flex-end;
    padding: 6px 8px;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
  }
  .btn-resign {
    background: none;
    border: none;
    color: var(--navy);
    font-size: 13px;
    font-weight: 600;
    font-family: var(--font-body);
    cursor: pointer;
    padding: 4px 8px;
    text-decoration: underline;
  }

  /* ── Signature Modal (Fullscreen, landscape-optimized) ── */
  .sig-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: #F5F5F0;
    flex-direction: column;
  }
  .sig-modal.open {
    display: flex;
  }

  /* Rotate hint — shown in portrait, hidden in landscape */
  .sig-rotate-hint {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 16px;
    padding: 40px;
    text-align: center;
  }
  .sig-rotate-hint .rotate-icon {
    width: 64px;
    height: 64px;
    color: var(--navy);
    animation: rotateNudge 2s ease-in-out infinite;
  }
  .sig-rotate-hint .rotate-text {
    font-size: 18px;
    font-weight: 600;
    color: var(--gray-800);
  }
  .sig-rotate-hint .rotate-sub {
    font-size: 14px;
    color: var(--gray-600);
  }
  .sig-rotate-hint .btn-sign-anyway {
    margin-top: 12px;
    padding: 10px 24px;
    font-size: 13px;
    font-family: var(--font-body);
    color: var(--gray-600);
    background: none;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    cursor: pointer;
  }

  @keyframes rotateNudge {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-15deg); }
    75% { transform: rotate(15deg); }
  }

  /* Signing area — hidden in portrait, shown in landscape (or forced) */
  .sig-signing-area {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
  }
  .sig-signing-area.force-show {
    display: flex;
  }

  .sig-modal-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--navy);
    color: var(--white);
    flex-shrink: 0;
  }
  .sig-modal-bar-title {
    font-size: 14px;
    font-weight: 600;
    opacity: 0.9;
  }
  .sig-modal-bar-actions {
    display: flex;
    gap: 10px;
  }
  .sig-modal-bar-actions button {
    padding: 8px 18px;
    font-size: 13px;
    font-weight: 600;
    font-family: var(--font-body);
    border-radius: 5px;
    cursor: pointer;
    border: none;
  }
  .btn-bar-cancel {
    background: rgba(255,255,255,0.15);
    color: var(--white);
  }
  .btn-bar-clear {
    background: rgba(255,255,255,0.25);
    color: var(--white);
  }
  .btn-bar-accept {
    background: var(--white);
    color: var(--navy);
    font-weight: 700;
  }
  .btn-bar-accept:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .sig-canvas-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--white);
    margin: 10px;
    border-radius: 8px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  }
  #sig-modal-canvas {
    width: 100%;
    height: 100%;
    display: block;
    touch-action: none;
  }
  .sig-guide-line {
    position: absolute;
    bottom: 28%;
    left: 32px;
    right: 32px;
    height: 1px;
    background: var(--gray-300);
    pointer-events: none;
  }
  .sig-guide-x {
    position: absolute;
    bottom: calc(28% - 6px);
    left: 32px;
    font-size: 16px;
    color: var(--gray-300);
    pointer-events: none;
    font-weight: 300;
    letter-spacing: 1px;
  }
  .sig-guide-label {
    position: absolute;
    bottom: calc(28% + 6px);
    right: 32px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--gray-400);
    pointer-events: none;
  }

  /* Landscape media query */
  @media (orientation: landscape) {
    .sig-rotate-hint { display: none; }
    .sig-signing-area { display: flex; }
  }
  @media (orientation: portrait) {
    .sig-rotate-hint { display: flex; }
    .sig-signing-area:not(.force-show) { display: none; }
  }

  /* ── Rotate Back Overlay ── */
  .rotate-back-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1001;
    background: rgba(27, 42, 74, 0.92);
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 40px;
    text-align: center;
  }
  .rotate-back-overlay.show {
    display: flex;
  }
  .rotate-back-overlay .rotate-back-icon {
    width: 56px;
    height: 56px;
    color: var(--white);
    animation: rotateBack 1.5s ease-in-out infinite;
  }
  .rotate-back-overlay .rotate-back-text {
    font-size: 18px;
    font-weight: 600;
    color: var(--white);
  }
  .rotate-back-overlay .rotate-back-sub {
    font-size: 14px;
    color: rgba(255,255,255,0.7);
  }
  @keyframes rotateBack {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(15deg); }
    75% { transform: rotate(-15deg); }
  }

  /* ── Submit Button ── */
  .btn-submit {
    width: 100%;
    padding: 16px;
    font-size: 16px;
    font-weight: 700;
    font-family: var(--font-body);
    letter-spacing: 0.3px;
    color: var(--white);
    background: var(--navy);
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.2s, opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 16px;
  }
  .btn-submit:active { background: var(--navy-light); }
  .btn-submit:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .btn-submit .spinner {
    width: 18px;
    height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3);
    border-top-color: var(--white);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }
  .btn-submit.loading .spinner { display: block; }
  .btn-submit.loading .btn-text { display: none; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Success Screen ── */
  .success-screen {
    display: none;
    text-align: center;
    padding: 60px 20px;
  }
  .success-screen.show { display: block; }
  .success-icon {
    width: 72px;
    height: 72px;
    background: var(--green-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    animation: scaleIn 0.4s ease;
  }
  .success-icon svg { width: 36px; height: 36px; color: var(--green); }
  .success-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 8px;
  }
  .success-detail {
    font-size: 14px;
    color: var(--gray-600);
    margin-bottom: 32px;
  }
  .btn-reset {
    display: inline-block;
    padding: 14px 32px;
    font-size: 15px;
    font-weight: 600;
    font-family: var(--font-body);
    color: var(--navy);
    background: var(--white);
    border: 2px solid var(--navy);
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-reset:active { background: var(--gray-100); }

  @keyframes scaleIn {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* ── Error Toast ── */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 16px;
    right: 16px;
    max-width: 640px;
    margin: 0 auto;
    background: var(--red);
    color: var(--white);
    padding: 14px 18px;
    border-radius: var(--radius);
    font-size: 14px;
    box-shadow: var(--shadow-md);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 200;
  }
  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  /* ── Footer ── */
  .footer {
    text-align: center;
    font-size: 11px;
    color: var(--gray-400);
    padding: 8px 16px 24px;
  }

  /* ── Form hidden state ── */
  .form-area.hidden { display: none; }

  /* ── Config Panel ── */
  .config-toggle {
    font-size: 11px;
    color: var(--gray-400);
    cursor: pointer;
    text-align: center;
    padding: 4px;
    margin-bottom: 16px;
  }
  .config-panel {
    display: none;
    padding: 14px 18px;
  }
  .config-panel.show { display: block; }
  .config-panel .text-input {
    font-size: 13px;
    padding: 10px 12px;
    margin-bottom: 8px;
  }
  .config-note {
    font-size: 11px;
    color: var(--gray-400);
    line-height: 1.4;
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-title">ADV Teammate Handbook</div>
  <div class="header-sub">Acknowledgement of Receipt &nbsp;|&nbsp; Revised February 2025</div>
</div>

<!-- Form Area -->
<div class="container form-area" id="formArea">

  <!-- Acknowledgement Text -->
  <div class="card">
    <div class="card-header">Acknowledgement of Receipt</div>
    <div class="ack-text" id="ackScroll">
      <p>I have received a copy of the Company's Handbook and the applicable Supplement(s) for the locations in which I work. I agree to read it and to comply with the policies and procedures described in the Handbook and Supplement(s). If I have any questions regarding any of the Handbook's provisions, I will consult with my supervisor, manager or Human Resources. I understand that if I do not follow the policies and procedures contained herein that I may be subject to disciplinary action, up to and including termination of employment.</p>
      <p>I also understand that this Handbook is the most up-to-date version of the Company's policies and procedures and replaces any prior written and oral communications about the subjects contained in it.</p>
      <p>I acknowledge that my employment relationship with the Company is "at-will", meaning that, regardless of anything contained in this Handbook and regardless of any custom or practice, either I or the Company may terminate my employment at any time, for any reason or no reason, with or without cause, and with or without procedural requirements. I understand that no representatives of the Company, other than the CEO in a writing signed by him/her/them, may enter into any agreements, or make any representations, written or oral, to alter my at-will status or otherwise create any contractual obligation between me and the Company.</p>
      <p>I further acknowledge that this handbook and the policies contained herein are not intended to create (and shall not be construed as creating) a contract (express or implied) for employment between the Company and any Teammate and that said policies can be modified by the Company at any time, with or without notice to me, in its sole and absolute discretion.</p>
      <p>By signing below, I acknowledge that I have received and will abide by the Company's Handbook and all the policies within it, including those on harassment, discrimination, retaliation, and bringing complaints regarding the same.</p>
    </div>
    <div class="scroll-hint" id="scrollHint">↓ Scroll to read full text</div>
    <div class="consent-box">
      <label class="consent-label">
        <input type="checkbox" id="consentCheck">
        <span>By signing electronically, I acknowledge I have received the ADV Teammate Handbook and the applicable State Supplement(s) for the location(s) where I work. I agree to read, understand, and comply with the policies and procedures in both documents, and I understand that failure to do so may result in disciplinary action, up to and including termination. I understand the Handbook is the most up-to-date version of Company policies, and that my employment is at-will unless state law provides otherwise. I understand the State Supplement(s) must be read together with the Handbook and will control where they provide different or more generous provisions. If I have questions, I will contact my supervisor/manager or Human Resources.</span>
      </label>
    </div>
  </div>

  <!-- Name -->
  <div class="card">
    <div class="card-body">
      <label class="field-label" for="teammateName">Printed Teammate Name</label>
      <input type="text" class="text-input" id="teammateName" placeholder="Your Full Name" autocomplete="name" autocapitalize="words" spellcheck="false">
    </div>
  </div>

  <!-- Signature -->
  <div class="card">
    <div class="card-body">
      <label class="field-label">Teammate Signature</label>
      <div class="sig-preview" id="sigPreview">
        <div class="sig-tap-prompt" id="sigPrompt">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
          <span>Tap to Sign</span>
        </div>
        <img id="sigPreviewImg" style="display:none;" alt="Signature">
      </div>
      <div class="sig-locked-actions" id="sigLockedActions" style="display:none;">
        <button type="button" class="btn-resign" id="btnResign">Re-sign</button>
      </div>
    </div>
  </div>

  <!-- Signature Modal -->
  <div class="sig-modal" id="sigModal">
    <!-- Portrait: rotate hint -->
    <div class="sig-rotate-hint" id="sigRotateHint">
      <svg class="rotate-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="2" width="16" height="20" rx="2"/>
        <path d="M12 18h.01"/>
        <path d="M2 12l2-2 2 2"/>
      </svg>
      <div class="rotate-text">Rotate your device to landscape</div>
      <div class="rotate-sub">This gives you the best signing area</div>
      <button type="button" class="btn-sign-anyway" id="btnSignAnyway">Sign in portrait anyway</button>
    </div>

    <!-- Landscape (or forced): signing interface -->
    <div class="sig-signing-area" id="sigSigningArea">
      <div class="sig-modal-bar">
        <span class="sig-modal-bar-title">Sign below</span>
        <div class="sig-modal-bar-actions">
          <button type="button" class="btn-bar-cancel" id="btnSigCancel">Cancel</button>
          <button type="button" class="btn-bar-clear" id="btnSigClear">Clear</button>
          <button type="button" class="btn-bar-accept" id="btnSigAccept" disabled>Accept</button>
        </div>
      </div>
      <div class="sig-canvas-area">
        <canvas id="sig-modal-canvas"></canvas>
        <div class="sig-guide-line"></div>
        <div class="sig-guide-x">&#10005;</div>
        <div class="sig-guide-label">Sign here</div>
      </div>
    </div>
  </div>

  <!-- Date -->
  <div class="card">
    <div class="card-body">
      <label class="field-label" for="signDate">Date</label>
      <input type="text" class="text-input" id="signDate" readonly>
    </div>
  </div>

  <!-- Submit -->
  <button class="btn-submit" id="btnSubmit" disabled>
    <span class="spinner"></span>
    <span class="btn-text">Sign & Submit</span>
  </button>

  <!-- Config -->
  <div class="config-toggle" id="configToggle">⚙ Server Settings</div>
  <div class="config-panel" id="configPanel">
    <label class="field-label">Local Server URL (optional)</label>
    <input type="url" class="text-input" id="localServerUrl" placeholder="https://acknowledgements.yourdomain.com/upload">
    <div class="config-note">If set, signed PDFs will also be POSTed to this endpoint. Leave blank to use email delivery only.</div>
  </div>

  <div class="footer">© 2025 Advantage Solutions Inc. | Confidential</div>
</div>

<!-- Success Screen -->
<div class="container success-screen" id="successScreen">
  <div class="success-icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
  </div>
  <div class="success-title">Acknowledgement Submitted</div>
  <div class="success-detail" id="successDetail"></div>
  <button class="btn-reset" id="btnReset">Sign Another</button>
</div>

<!-- Rotate Back Overlay -->
<div class="rotate-back-overlay" id="rotateBackOverlay">
  <svg class="rotate-back-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <rect x="4" y="2" width="16" height="20" rx="2"/>
    <path d="M12 18h.01"/>
    <path d="M2 12l2-2 2 2"/>
  </svg>
  <div class="rotate-back-text">Rotate back to portrait</div>
  <div class="rotate-back-sub">Turn your device upright to continue</div>
</div>

<!-- Error Toast -->
<div class="toast" id="toast"></div>

<script>


// ═══════════════════════════════════════════════
// DOM REFS
// ═══════════════════════════════════════════════
const formArea = document.getElementById('formArea');
const successScreen = document.getElementById('successScreen');
const successDetail = document.getElementById('successDetail');
const consentCheck = document.getElementById('consentCheck');
const teammateName = document.getElementById('teammateName');
const signDate = document.getElementById('signDate');
const btnSubmit = document.getElementById('btnSubmit');
const btnReset = document.getElementById('btnReset');
const toast = document.getElementById('toast');
const scrollHint = document.getElementById('scrollHint');
const ackScroll = document.getElementById('ackScroll');
const configToggle = document.getElementById('configToggle');
const configPanel = document.getElementById('configPanel');
const localServerUrl = document.getElementById('localServerUrl');

// Signature modal refs
const sigPreview = document.getElementById('sigPreview');
const sigPrompt = document.getElementById('sigPrompt');
const sigPreviewImg = document.getElementById('sigPreviewImg');
const sigLockedActions = document.getElementById('sigLockedActions');
const btnResign = document.getElementById('btnResign');
const sigModal = document.getElementById('sigModal');
const sigModalCanvas = document.getElementById('sig-modal-canvas');
const sigSigningArea = document.getElementById('sigSigningArea');
const btnSignAnyway = document.getElementById('btnSignAnyway');
const btnSigCancel = document.getElementById('btnSigCancel');
const btnSigClear = document.getElementById('btnSigClear');
const btnSigAccept = document.getElementById('btnSigAccept');

// ═══════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════
let capturedSignatureDataUrl = null;
let enteredModalInPortrait = false;

// ═══════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════

// Date
const today = new Date();
const dateStr = String(today.getMonth()+1).padStart(2,'0') + '/' +
                String(today.getDate()).padStart(2,'0') + '/' +
                today.getFullYear();
signDate.value = dateStr;

// Modal Signature Pad
let modalSignaturePad = null;

function initModalCanvas() {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  const rect = sigModalCanvas.getBoundingClientRect();
  if (rect.width === 0 || rect.height === 0) return; // not visible yet
  sigModalCanvas.width = rect.width * ratio;
  sigModalCanvas.height = rect.height * ratio;
  sigModalCanvas.getContext('2d').scale(ratio, ratio);
  if (modalSignaturePad) modalSignaturePad.clear();
}

function openSignModal() {
  enteredModalInPortrait = window.innerHeight > window.innerWidth;
  sigModal.classList.add('open');
  sigSigningArea.classList.remove('force-show');
  document.body.style.overflow = 'hidden';

  if (!modalSignaturePad) {
    modalSignaturePad = new SignaturePad(sigModalCanvas, {
      backgroundColor: 'rgb(255,255,255)',
      penColor: '#1B2A4A',
      minWidth: 1.5,
      maxWidth: 3.5,
    });
    modalSignaturePad.addEventListener('endStroke', () => {
      btnSigAccept.disabled = modalSignaturePad.isEmpty();
    });
  }

  // If already landscape, init canvas immediately
  if (window.innerWidth > window.innerHeight) {
    setTimeout(initModalCanvas, 80);
  }
  btnSigAccept.disabled = true;
}

// Re-init canvas when orientation changes while modal is open
window.addEventListener('resize', () => {
  if (sigModal.classList.contains('open') && sigSigningArea.offsetParent !== null) {
    setTimeout(initModalCanvas, 100);
  }
});

// Also listen for orientation change
screen.orientation?.addEventListener('change', () => {
  if (sigModal.classList.contains('open')) {
    setTimeout(initModalCanvas, 150);
  }
});

function closeSignModal() {
  sigModal.classList.remove('open');
  sigSigningArea.classList.remove('force-show');
  document.body.style.overflow = '';
}

// "Sign in portrait anyway" button
btnSignAnyway.addEventListener('click', () => {
  sigSigningArea.classList.add('force-show');
  setTimeout(initModalCanvas, 80);
});

// Open modal on tap
sigPreview.addEventListener('click', () => {
  if (capturedSignatureDataUrl) return; // locked
  openSignModal();
});

// Re-sign button
btnResign.addEventListener('click', () => {
  capturedSignatureDataUrl = null;
  sigPreviewImg.style.display = 'none';
  sigPrompt.style.display = '';
  sigPreview.classList.remove('has-sig');
  sigLockedActions.style.display = 'none';
  validateForm();
  openSignModal();
});

// Cancel
btnSigCancel.addEventListener('click', closeSignModal);

// Clear
btnSigClear.addEventListener('click', () => {
  if (modalSignaturePad) {
    modalSignaturePad.clear();
    btnSigAccept.disabled = true;
  }
});

// Accept
btnSigAccept.addEventListener('click', () => {
  if (!modalSignaturePad || modalSignaturePad.isEmpty()) return;

  capturedSignatureDataUrl = modalSignaturePad.toDataURL('image/png');

  // Show preview
  sigPreviewImg.src = capturedSignatureDataUrl;
  sigPreviewImg.style.display = 'block';
  sigPrompt.style.display = 'none';
  sigPreview.classList.add('has-sig');
  sigLockedActions.style.display = '';

  closeSignModal();
  validateForm();

  // If they entered in portrait and are now in landscape, show rotate-back hint
  const rotateBackOverlay = document.getElementById('rotateBackOverlay');
  if (enteredModalInPortrait && window.innerWidth > window.innerHeight) {
    rotateBackOverlay.classList.add('show');

    // Auto-dismiss when they rotate back to portrait
    function checkPortrait() {
      if (window.innerHeight > window.innerWidth) {
        rotateBackOverlay.classList.remove('show');
        window.removeEventListener('resize', checkPortrait);
      }
    }
    window.addEventListener('resize', checkPortrait);

    // Also dismiss on tap as a fallback
    rotateBackOverlay.addEventListener('click', () => {
      rotateBackOverlay.classList.remove('show');
      window.removeEventListener('resize', checkPortrait);
    }, { once: true });
  }
});

// Scroll hint
ackScroll.addEventListener('scroll', () => {
  if (ackScroll.scrollTop + ackScroll.clientHeight >= ackScroll.scrollHeight - 10) {
    scrollHint.style.display = 'none';
  }
});

// Config panel
configToggle.addEventListener('click', () => {
  configPanel.classList.toggle('show');
});

// Load saved server URL (default to production endpoint)
const defaultUrl = 'https://upload.the-dump-bin.com/upload';
const savedUrl = localStorage.getItem('localServerUrl') || defaultUrl;
localServerUrl.value = savedUrl;
localServerUrl.addEventListener('input', () => {
  localStorage.setItem('localServerUrl', localServerUrl.value);
});

// ═══════════════════════════════════════════════
// FORM VALIDATION
// ═══════════════════════════════════════════════
function validateForm() {
  const valid = consentCheck.checked &&
                teammateName.value.trim().length > 0 &&
                capturedSignatureDataUrl !== null;
  btnSubmit.disabled = !valid;
  return valid;
}

consentCheck.addEventListener('change', validateForm);
teammateName.addEventListener('input', validateForm);

// ═══════════════════════════════════════════════
// PDF GENERATION (fill blank template)
// ═══════════════════════════════════════════════
async function generatePDF(name, sigDataUrl, date) {
  const { PDFDocument, rgb } = PDFLib;

  // Fetch the blank template from the same repo
  const templateUrl = new URL('blank_color_acknowledgement.pdf', window.location.href).href;
  const templateBytes = await fetch(templateUrl).then(r => r.arrayBuffer());

  const pdfDoc = await PDFDocument.load(templateBytes);
  const form = pdfDoc.getForm();
  const page = pdfDoc.getPage(0);
  const pageHeight = page.getHeight();

  // Fill checkbox
  try {
    const checkbox = form.getCheckBox('acknowledge_checkbox');
    checkbox.check();
  } catch (e) { console.warn('Checkbox field not found:', e); }

  // Fill printed name
  try {
    const nameField = form.getTextField('printed_name');
    nameField.setText(name);
  } catch (e) { console.warn('Name field not found:', e); }

  // Fill date
  try {
    const dateField = form.getTextField('date');
    dateField.setText(date);
  } catch (e) { console.warn('Date field not found:', e); }

  // Embed signature image onto the page
  try {
    const sigImage = await pdfDoc.embedPng(sigDataUrl);
    const sigDims = sigImage.scale(1);
    // signature_image field rect: x=57, y=603 to x=284, y=634 (PDF coords, origin bottom-left)
    // PyMuPDF reports top-left origin, so convert: PDF_y = pageHeight - pymu_y
    const fieldX = 57;
    const fieldY = pageHeight - 634; // bottom of field in PDF coords
    const fieldW = 227; // 284 - 57
    const fieldH = 30;  // 634 - 603

    let w = sigDims.width;
    let h = sigDims.height;
    // Scale to fit within field bounds
    const scaleW = fieldW / w;
    const scaleH = fieldH / h;
    const scale = Math.min(scaleW, scaleH);
    w = w * scale;
    h = h * scale;

    page.drawImage(sigImage, {
      x: fieldX,
      y: fieldY,
      width: w,
      height: h,
    });
  } catch (e) { console.warn('Signature embed failed:', e); }

  // Flatten form so fields aren't editable
  form.flatten();

  return await pdfDoc.save();
}

// ═══════════════════════════════════════════════
// FILE NAME HELPER
// ═══════════════════════════════════════════════
function buildFilename(fullName, date) {
  const parts = fullName.trim().split(/\s+/);
  const last = parts.length > 1 ? parts[parts.length - 1] : parts[0];
  const first = parts.length > 1 ? parts.slice(0, -1).join('_') : '';
  const datePart = date.replace(/\//g, '');
  const namePart = first ? `${last}_${first}` : last;
  return `${namePart}_Acknowledgement_${datePart}.pdf`;
}



// ═══════════════════════════════════════════════
// DELIVERY: LOCAL SERVER POST
// ═══════════════════════════════════════════════
async function postToLocal(pdfBytes, filename, fullName, date) {
  const url = localServerUrl.value.trim();
  if (!url) return null;

  try {
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const formData = new FormData();
    formData.append('file', blob, filename);
    formData.append('filename', filename);
    formData.append('teammate_name', fullName);
    formData.append('date_signed', date);

    const resp = await fetch(url, { method: 'POST', body: formData });
    if (!resp.ok) throw new Error(`Server responded ${resp.status}`);
    return 'server';
  } catch (e) {
    console.warn('Local server POST failed:', e.message);
    return null;
  }
}

// ═══════════════════════════════════════════════
// FALLBACK: BROWSER DOWNLOAD
// ═══════════════════════════════════════════════
function downloadPDF(pdfBytes, filename) {
  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ═══════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════
function showToast(msg, duration = 4000) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

// ═══════════════════════════════════════════════
// SUBMIT
// ═══════════════════════════════════════════════
btnSubmit.addEventListener('click', async () => {
  if (!validateForm()) return;

  btnSubmit.classList.add('loading');
  btnSubmit.disabled = true;

  try {
    const fullName = teammateName.value.trim();
    const date = signDate.value;
    const sigDataUrl = capturedSignatureDataUrl;
    const filename = buildFilename(fullName, date);

    // Generate PDF
    const pdfBytes = await generatePDF(fullName, sigDataUrl, date);

    // Attempt local server delivery
    const serverResult = await postToLocal(pdfBytes, filename, fullName, date);

    let detail = `${fullName} — ${date}`;
    if (serverResult === 'server') {
      detail += '\nSaved to server.';
    } else {
      // Fallback: download to device
      downloadPDF(pdfBytes, filename);
      detail += '\nServer unavailable — PDF downloaded to your device.';
    }

    successDetail.textContent = detail;
    formArea.classList.add('hidden');
    successScreen.classList.add('show');

  } catch (e) {
    console.error('Submission error:', e);
    showToast('Something went wrong. Please try again.');
    btnSubmit.classList.remove('loading');
    btnSubmit.disabled = false;
  }
});

// ═══════════════════════════════════════════════
// RESET
// ═══════════════════════════════════════════════
btnReset.addEventListener('click', () => {
  successScreen.classList.remove('show');
  formArea.classList.remove('hidden');
  consentCheck.checked = false;
  teammateName.value = '';
  capturedSignatureDataUrl = null;
  sigPreviewImg.style.display = 'none';
  sigPrompt.style.display = '';
  sigPreview.classList.remove('has-sig');
  sigLockedActions.style.display = 'none';
  if (modalSignaturePad) modalSignaturePad.clear();
  scrollHint.style.display = '';
  btnSubmit.classList.remove('loading');
  btnSubmit.disabled = true;
  teammateName.focus();
});
</script>
</body>
</html>